import gradio as gr
from transformers import AutoModelForCausalLM, AutoTokenizer
import torch
import re

# ë””ë°”ì´ìŠ¤ ì„¤ì •
#device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
device = torch.device("cpu")  # GPU ëŒ€ì‹  CPU ì‚¬ìš©

# ëª¨ë¸ ì €ì¥ëœ ë¡œì»¬ ê²½ë¡œ
explainer_model_path = "C:/Users/LWG/Downloads/model"  # ê²½ë¡œ ì•ì— rì„ ë¶™ì—¬ ì›ì‹œ ë¬¸ìì—´ë¡œ ì‚¬ìš©

# ëª¨ë¸ ë° í† í¬ë‚˜ì´ì € ë¡œë“œ
explainer_tokenizer = AutoTokenizer.from_pretrained(explainer_model_path)
explainer_model = AutoModelForCausalLM.from_pretrained(explainer_model_path).to(device)




# ëŒ€í™” ìƒíƒœ ê´€ë¦¬
story_progress = 0  # ì´ì•¼ê¸° ì§„í–‰ ë‹¨ê³„ (1~5)
story_segments = []  # 5ë‹¨ê³„ë¡œ ë‚˜ëˆˆ ì´ì•¼ê¸° ì €ì¥

few_shot_examples = [
    {
        "input": "ê¼¬ê¼¬ë¬´ê°€ ë¬´ì—‡ì¸ì§€ ì„¤ëª…í•´ì¤˜.",
        "output": "ê¼¬ë¦¬ì— ê¼¬ë¦¬ë¥¼ ë¬´ëŠ” ê·¸ë‚  ì´ì•¼ê¸°, ì¤„ì—¬ì„œ â€˜ê¼¬ê¼¬ë¬´â€™. ì‚¬ê±´ì„ í¥ë¯¸ì§„ì§„í•˜ê²Œ í’€ì–´ê°€ë©´ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ë°˜ì „ê³¼ ì¶©ê²©ì ì¸ ì „ê°œë¥¼ ì„ ì‚¬í•˜ëŠ” SBS êµì–‘ í”„ë¡œê·¸ë¨ì´ì•¼. ì´ì•¼ê¸° ì† ì¸ë¬¼ë“¤ì˜ ì‹¬ë¦¬ë¥¼ ê¹Šì´ íŒŒê³ ë“¤ê³ , ì¤‘ìš”í•œ ìˆœê°„ë§ˆë‹¤ 'ê·¸ëŸ°ë° ë§ì´ì•¼' ê°™ì€ ë°˜ì „ ìš”ì†Œë¥¼ ë„£ì–´ ëª°ì…ê°ì„ ë†’ì´ëŠ” ê²Œ íŠ¹ì§•ì´ì§€."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•˜ëŠ” ë°©ë²• ì•Œë ¤ì¤˜.",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ë³´í†µ **ì‹œê°„ê³¼ ì¥ì†Œ**ë¥¼ ê°•ì¡°í•˜ë©´ì„œ ì‹œì‘í•´. ì˜ˆë¥¼ ë“¤ë©´: 'ë•ŒëŠ” 1999ë…„ 10ì›”, ëŒ€ì „ì˜ í•œ ê°€ì •ì§‘.' ì´ë ‡ê²Œ ë§ì´ì•¼. ê·¸ë¦¬ê³  **ì¸ë¬¼ ì†Œê°œì™€ ì‚¬ê±´ì˜ í‰ë²”í•œ ì‹œì‘**ì„ ë³´ì—¬ì¤˜. í•˜ì§€ë§Œ ê³§ì´ì–´ **ë°˜ì „ ìš”ì†Œ**ê°€ ë“±ì¥í•˜ë©´ì„œ ë³¸ê²©ì ì¸ ì´ì•¼ê¸°ê°€ ì‹œì‘ë˜ì§€."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ë°˜ì „ì´ ë‚˜ì˜¬ ë•Œ ì–´ë–»ê²Œ í‘œí˜„í•´?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ë°˜ì „ì´ ìˆì„ ë•Œ **'ê·¸ëŸ°ë° ë§ì´ì•¼'** ê°™ì€ í‘œí˜„ì„ ì¨ì„œ ì‹œì²­ìë“¤ì˜ ê¸°ëŒ€ë¥¼ ê¹¨. ì˜ˆë¥¼ ë“¤ì–´: 'í‰ë²”í•œ ì‹ í˜¼ë¶€ë¶€ì˜ í–‰ë³µí•œ ë‚˜ë‚ ... ê·¸ëŸ°ë° ë§ì´ì•¼. ë‚¨í¸ì´ ì‹¤ì¢…ëœ ì§€ ë‚˜í˜ì§¸, ì¶©ê²©ì ì¸ ì†Œì‹ì´ ì „í•´ì¡ŒìŠµë‹ˆë‹¤. ë‚¨í¸ì´ ì°¨ ì•ˆì—ì„œ ìˆ¨ì§„ ì±„ ë°œê²¬ëœ ê²ë‹ˆë‹¤.' ì´ë ‡ê²Œ ë°˜ì „ì„ ê°•ì¡°í•˜ë©´ì„œ ê¸´ì¥ê°ì„ ë†’ì—¬."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œëŠ” ì–´ë–»ê²Œ ì‹œì²­ìì˜ ëª°ì…ì„ ìœ ë„í•´?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ì´ì•¼ê¸°ë¥¼ í’€ì–´ë‚˜ê°€ë©´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì§ˆë¬¸ì„ ë˜ì ¸. ì˜ˆë¥¼ ë“¤ë©´: 'ì, ì—¬ê¸°ì„œ ì´ìƒí•œ ì ì´ í•˜ë‚˜ ìˆì–´. í”¼í•´ìê°€ ì°¨ì—ì„œ ë°œê²¬ëëŠ”ë°, ì¤‘ìš”í•œ ê²ƒì´ ì‚¬ë¼ì¡Œì–´. ê·¸ê±´ ë­ì˜€ì„ê¹Œ?' ì´ë ‡ê²Œ ì§ˆë¬¸ì„ ë˜ì§€ë©´ ì‹œì²­ìë“¤ì€ ìŠ¤ìŠ¤ë¡œ ì¶”ë¦¬í•˜ê²Œ ë˜ê³ , ì´ì•¼ê¸° ì†ìœ¼ë¡œ ë” ë¹ ì ¸ë“¤ê²Œ ë¼."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œëŠ” ì‚¬ê±´ì˜ ì§„í–‰ ê³¼ì •ì„ ì–´ë–»ê²Œ ì„¤ëª…í•´?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” **ì‹œê°„ ìˆœì„œ**ë¥¼ ê°•ì¡°í•˜ë©´ì„œ ì´ì•¼ê¸°ë¥¼ ì§„í–‰í•´. 'ì, 10ì›” 2ì¼. í˜¼ì¸ì‹ ê³ ë¥¼ í–ˆì–´. ê·¸ë¦¬ê³  ë³´ë¦„ í›„, ìƒëª…ë³´í—˜ì„ ê°€ì…í–ˆì§€. ê·¸ë¦¬ê³  ë‹¨ 2ì£¼ í›„... ë‚¨í¸ì´ ì‚¬ë¼ì ¸.' ì´ë ‡ê²Œ íŠ¹ì • ë‚ ì§œë¥¼ ë°˜ë³µí•´ì„œ ê°•ì¡°í•˜ë©´ì„œ ê¸´ë°•í•œ ëŠë‚Œì„ ì¤˜."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì˜ ê²°ë¡ ì„ ë‚´ë¦¬ëŠ” ë°©ì‹ ì•Œë ¤ì¤˜.",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ë§ˆì§€ë§‰ì—ë„ ì—¬ìš´ì„ ë‚¨ê¸°ë©´ì„œ ë§ˆë¬´ë¦¬í•´. ì˜ˆë¥¼ ë“¤ë©´: 'ê·¸ë ‡ê²Œ 25ë…„ì´ ì§€ë‚œ ì§€ê¸ˆë„, ê°•ì˜ë¯¼ì€ ì‚¬í˜•ìˆ˜ë¡œ ë³µì—­ ì¤‘ì´ì•¼. í•˜ì§€ë§Œâ€¦ ì•„ì§ë„ í’€ë¦¬ì§€ ì•Šì€ ì˜ë¬¸ì´ í•˜ë‚˜ ìˆì–´. ê·¸ë‚  ë°¤, ë‚šì‹œí„°ì—ì„œ ì •ë§ ê·¸ë“¤ë§Œ ìˆì—ˆì„ê¹Œ?' ì´ë ‡ê²Œ ìƒˆë¡œìš´ ì˜ë¬¸ì„ ë˜ì§€ë©´ì„œ ë§ˆë¬´ë¦¬í•˜ëŠ” ê²Œ íŠ¹ì§•ì´ì§€."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œëŠ” ì¦ê±°ê°€ ë“±ì¥í•  ë•Œ í‘œí˜„í•˜ëŠ” ë°©ë²• ì•Œë ¤ì¤˜.",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ê²°ì •ì ì¸ ì¦ê±°ê°€ ë‚˜ì˜¬ ë•Œ **ì ì§„ì ì¸ ì„œìˆ **ì„ í†µí•´ ê·¹ì  ê¸´ì¥ê°ì„ ë†’ì—¬. ì˜ˆë¥¼ ë“¤ë©´: 'í˜•ì‚¬ë“¤ì€ ì°¨ ì•ˆì„ ìƒ…ìƒ…ì´ ë’¤ì¡Œì–´. ê·¸ëŸ°ë°â€¦ ì¡°ìˆ˜ì„ì—ì„œ ë°œê²¬ëœ í˜ˆí”. ë¶„ì„ ê²°ê³¼, ê·¸ê²ƒì€â€¦ í”¼í•´ìì˜ ê²ƒì´ ì•„ë‹ˆì—ˆì–´!' ì´ë ‡ê²Œ **ê²°ë¡ ì„ ì ì§„ì ìœ¼ë¡œ ë“œëŸ¬ë‚´ëŠ” ë°©ì‹**ì´ì•¼."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ì‚¬ê±´ì˜ ë°°ê²½ì„ ì„¤ëª…í•  ë•Œ í‘œí˜„í•˜ëŠ” ë°©ë²• ì•Œë ¤ì¤˜.",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ì‚¬ê±´ì˜ ë°°ê²½ì„ ì„¤ì •í•  ë•Œ **ì°¨ë¶„í•˜ê²Œ ì‹œì‘í•˜ì§€ë§Œ, ì ì°¨ ê¸´ì¥ê°ì„ ë†’ì´ëŠ” ë°©ì‹**ì„ ì‚¬ìš©í•´. ì˜ˆë¥¼ ë“¤ë©´: 'ë•ŒëŠ” 1980ë…„ 5ì›”. ê´‘ì£¼ì˜ ê±°ë¦¬ì—ëŠ” í‰ë²”í•œ ì‹œë¯¼ë“¤ì´ ê°€ë“í–ˆì–´. í•˜ì§€ë§Œâ€¦ êµ°ì¸ë“¤ì´ ì´ì„ ë“¤ê³  ê±°ë¦¬ë¡œ ë‚˜ì˜¤ê¸° ì‹œì‘í–ˆì§€.' ì´ë ‡ê²Œ ì ì§„ì ìœ¼ë¡œ ë¶„ìœ„ê¸°ë¥¼ ê³ ì¡°ì‹œí‚¤ëŠ” ê²Œ ì¤‘ìš”í•´."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œëŠ” ì‚¬ê±´ì˜ ë°°ê²½ì„ ê°•ì¡°í•  ë•Œ ì–´ë–»ê²Œ í‘œí˜„í•´?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ì‚¬ê±´ì˜ ë°°ê²½ì„ ë¬˜ì‚¬í•  ë•Œ ê°ê°ì ì¸ í‘œí˜„ì„ ë§ì´ ì‚¬ìš©í•´. ì˜ˆë¥¼ ë“¤ë©´: 'ë•ŒëŠ” 1985ë…„ ì—¬ë¦„. ë¬´ë”ìš´ ë‚ ì”¨ ì†, í•œ ë‚¨ìê°€ ì‹œì¥ í•œê°€ìš´ë°ë¥¼ ì²œì²œíˆ ê±¸ì–´ê°€ê³  ìˆì—ˆì–´. í•˜ì§€ë§Œâ€¦ ëª‡ ì‹œê°„ í›„, ê·¸ ë‚¨ìëŠ” í”ì ë„ ì—†ì´ ì‚¬ë¼ì¡Œì§€.' ì´ë ‡ê²Œ ìƒìƒí•œ ë¬˜ì‚¬ë¥¼ í†µí•´ ì‹œì²­ìì˜ ìƒìƒë ¥ì„ ìê·¹í•´."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ë“±ì¥ì¸ë¬¼ì˜ ì‹¬ë¦¬ë¥¼ ê°•ì¡°í•˜ëŠ” ë°©ë²•ì€?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ë“±ì¥ì¸ë¬¼ì˜ ì‹¬ë¦¬ë¥¼ ê°•ì¡°í•  ë•Œ ê°ì •ì´ì…ì„ ìœ ë„í•˜ëŠ” ì§ˆë¬¸ì„ ë˜ì ¸. ì˜ˆë¥¼ ë“¤ë©´: 'ìˆ˜ì—° ì”¨ëŠ” ì•„ë¬´ê²ƒë„ ëª¨ë¥¸ ì±„ ì €ë…ì„ ì°¨ë¦¬ê³  ìˆì—ˆì–´. í•˜ì§€ë§Œâ€¦ ê·¸ë…€ëŠ” ëª°ëì§€. ê·¸ë‚ ì´ ë‚¨í¸ì„ ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ëŠ” ë‚ ì´ ë  ê±°ë¼ëŠ” ê±¸.' ì´ë ‡ê²Œ ì¸ë¬¼ì˜ ê°ì • ë³€í™”ë¥¼ ê°•ì¡°í•´ì„œ ëª°ì…ê°ì„ ë†’ì—¬."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œëŠ” ë°˜ë³µì ì¸ í‘œí˜„ì„ ì–´ë–»ê²Œ í™œìš©í•´?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” íŠ¹ì • ë‹¨ì–´ë‚˜ êµ¬ì ˆì„ ë°˜ë³µí•´ì„œ ê°•ì¡°í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ê¸´ì¥ê°ì„ ì¡°ì„±í•´. ì˜ˆë¥¼ ë“¤ë©´: 'ê·¸ë‚  ë°¤, ê²½ì°°ì€ ë‹¨ì„œë¥¼ ì°¾ì§€ ëª»í–ˆì–´. ë‹¨ í•˜ë‚˜ì˜ ë‹¨ì„œë„. ë‹¨ í•œ ì¡°ê°ë„. ê·¸ëŸ°ë°â€¦ ë‹¤ìŒ ë‚ , ë†€ë¼ìš´ ì‚¬ì‹¤ì´ ë°í˜€ì§€ì§€.' ì´ë ‡ê²Œ ë°˜ë³µì ì¸ ë¬¸ì¥ì„ í™œìš©í•´ì„œ ì ì  ì••ë°•ê°ì„ ë†’ì´ëŠ” ê±°ì§€."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ì¤‘ìš”í•œ ìˆœê°„ì„ ê°•ì¡°í•  ë•Œ ì–´ë–¤ ê¸°ë²•ì„ ì‚¬ìš©í•´?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ì¤‘ìš”í•œ ìˆœê°„ì„ ê°•ì¡°í•  ë•Œ **ì¼ë¶€ ì •ë³´ë¥¼ ìˆ¨ê¸´ ì±„ ë¬¸ì¥ì„ ëŠì–´** ê¶ê¸ˆì¦ì„ ìœ ë°œí•´. ì˜ˆë¥¼ ë“¤ë©´: 'í˜•ì‚¬ë“¤ì€ ì„œëì„ ì—´ì—ˆì–´. ê·¸ë¦¬ê³ â€¦ ë¯¿ê¸° í˜ë“  ê±¸ ë°œê²¬í•˜ì§€. ê·¸ê²ƒì€ ë°”ë¡œâ€¦' ì´ë ‡ê²Œ ê¶ê¸ˆì¦ì„ ê·¹ëŒ€í™”í•˜ë©´ì„œ ê¸´ì¥ê°ì„ ìœ ì§€í•˜ëŠ” ë°©ì‹ì´ì•¼."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ê³µí¬ê°ì„ ì¡°ì„±í•  ë•Œ ì–´ë–¤ ê¸°ë²•ì„ ì‚¬ìš©í•´?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ê³µí¬ê°ì„ ì¡°ì„±í•  ë•Œ **ëŠë¦° í…œí¬ë¡œ ì§„í–‰í•˜ë©° ì£¼ë³€ ë¶„ìœ„ê¸°ë¥¼ ê°•ì¡°í•´**. ì˜ˆë¥¼ ë“¤ë©´: 'ê¹œê¹œí•œ ë°¤ì´ì—ˆì–´. ê±°ë¦¬ì—ëŠ” ì•„ë¬´ë„ ì—†ì—ˆì§€. ê·¸ëŸ°ë°â€¦ ëˆ„êµ°ê°€ ë”°ë¼ì˜¤ê³  ìˆì—ˆì–´. ë°œì†Œë¦¬ê°€ í•˜ë‚˜â€¦ ë‘˜â€¦ ê°€ê¹Œì›Œì§€ê³  ìˆì—ˆì§€.' ì´ë ‡ê²Œ ê°ê°ì ì¸ í‘œí˜„ê³¼ í…œí¬ ì¡°ì ˆì„ í™œìš©í•´ ê¸´ì¥ê°ì„ ê³ ì¡°ì‹œì¼œ."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ê²°ë§ì„ ê°•ì¡°í•˜ëŠ” ë°©ë²•ì€?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ì˜ˆìƒê³¼ ë‹¤ë¥¸ ê²°ë§ì„ ê°•ì¡°í•  ë•Œ ë§ˆì§€ë§‰ ìˆœê°„ê¹Œì§€ ê¸´ì¥ì„ ìœ ì§€í•´. ì˜ˆë¥¼ ë“¤ë©´: 'ëª¨ë“  ê²Œ ëë‚œ ì¤„ ì•Œì•˜ì–´. ë²”ì¸ì€ ê²€ê±°ëê³ , ì‚¬ê±´ì€ í•´ê²°ëì§€. ê·¸ëŸ°ë° ë§ì´ì•¼â€¦ 10ë…„ í›„, í•œ í†µì˜ í¸ì§€ê°€ ë„ì°©í–ˆì–´.' ì´ë ‡ê²Œ ê²°ë§ ë¶€ë¶„ì—ì„œ ë˜ ë‹¤ë¥¸ ë°˜ì „ì„ ì œì‹œí•´ì„œ ì‹œì²­ìì˜ í¥ë¯¸ë¥¼ ìœ ë„í•´."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ì—ì„œ ë²”ì¸ì˜ ì‹¬ë¦¬ë¥¼ ë¬˜ì‚¬í•˜ëŠ” ë°©ë²•ì€?",
        "output": "ê¼¬ê¼¬ë¬´ëŠ” ë²”ì¸ì˜ ì‹¬ë¦¬ë¥¼ ë¬˜ì‚¬í•  ë•Œ **í–‰ë™ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•˜ë©´ì„œ ë¶ˆì•ˆê°ì„ ê°•ì¡°í•´**. ì˜ˆë¥¼ ë“¤ë©´: 'ê·¸ëŠ” ê³„ì†í•´ì„œ ì†ì„ ë–¨ê³  ìˆì—ˆì–´. ê·¸ë¦¬ê³ â€¦ ì°½ë°–ì„ ìê¾¸ í™•ì¸í–ˆì§€. ë§ˆì¹˜ ëˆ„êµ°ê°€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì²˜ëŸ¼.' ì´ë ‡ê²Œ ì‘ì€ í–‰ë™ í•˜ë‚˜í•˜ë‚˜ë¥¼ ë¬˜ì‚¬í•˜ë©´ì„œ ì‹œì²­ìê°€ ê¸´ì¥ê°ì„ ëŠë¼ê²Œ ë§Œë“¤ì–´."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ ìŠ¤íƒ€ì¼ë¡œ 1972ë…„ ì›Œí„°ê²Œì´íŠ¸ ì‚¬ê±´ì„ ì„¤ëª…í•´ì¤˜.",
        "output": "ë•ŒëŠ” 1972ë…„. ë¯¸êµ­ ëŒ€í†µë ¹ ì„ ê±°ë¥¼ ì•ë‘” ì›Œì‹±í„´ D.C. ë¯¼ì£¼ë‹¹ ë³¸ë¶€ì— ë‚¯ì„  ì‚¬ëŒë“¤ì´ ì¹¨ì…í•´. ë‹¨ìˆœí•œ ì ˆë„ì¼ê¹Œ? ê·¸ëŸ°ë° ë§ì´ì•¼ ì´ ì‚¬ê±´ì˜ ë°°í›„ì— ë‹¹ì‹œ ëŒ€í†µë ¹ì´ì—ˆë˜ ë¦¬ì²˜ë“œ ë‹‰ìŠ¨ì´ ìˆì—ˆë‹¤ë©´?"
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ ìŠ¤íƒ€ì¼ë¡œ 1994ë…„ ì„±ìˆ˜ëŒ€êµ ë¶•ê´´ ì‚¬ê±´ì„ ì„¤ëª…í•´ì¤˜.",
        "output": "ë•ŒëŠ” 1994ë…„ 10ì›” 21ì¼, ì„œìš¸ ì„±ìˆ˜ëŒ€êµ. í‰ë²”í•œ ì¶œê·¼ê¸¸ì´ì—ˆì–´. ê·¸ëŸ°ë° ë§ì´ì•¼â€¦ ê°‘ìê¸° ë‹¤ë¦¬ê°€ 'ì¾…!' ë¬´ë„ˆì ¸ ë‚´ë¦° ê±°ì•¼. ê³¼ì—°, ì´ ì‚¬ê³ ëŠ” ì •ë§ ì˜ˆì¸¡í•  ìˆ˜ ì—†ì—ˆë˜ ê±¸ê¹Œ?"
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ ìŠ¤íƒ€ì¼ë¡œ 1997ë…„ IMF ì™¸í™˜ìœ„ê¸°ë¥¼ ì„¤ëª…í•´ì¤˜.",
        "output": "ë•ŒëŠ” 1997ë…„ 11ì›”. ëŒ€í•œë¯¼êµ­ ê²½ì œê°€ íœ˜ì²­ì´ê¸° ì‹œì‘í•´. ê·¸ëŸ°ë° ë§ì´ì•¼â€¦ ë‹¨ìˆœí•œ ê²½ê¸° ì¹¨ì²´ê°€ ì•„ë‹ˆì—ˆì–´. ê²°êµ­ ëŒ€í•œë¯¼êµ­ì€ IMFì— êµ¬ì œê¸ˆìœµì„ ì‹ ì²­í•˜ëŠ” ì‚¬ìƒ ì´ˆìœ ì˜ ì‚¬íƒœë¥¼ ë§ì´í•˜ê²Œ ë˜ì§€."
    },
    {
        "input": "ê¼¬ê¼¬ë¬´ ìŠ¤íƒ€ì¼ë¡œ 1980ë…„ 5.18 ê´‘ì£¼ ë¯¼ì£¼í™”ìš´ë™ì„ ì„¤ëª…í•´ì¤˜.",
        "output": "ë•ŒëŠ” 1980ë…„ 5ì›”. ê´‘ì£¼ ì‹œë¯¼ë“¤ì€ êµ°ë¶€ ë…ì¬ì— ë§ì„œ ë¯¼ì£¼í™”ë¥¼ ì™¸ì³¤ì–´. ê·¸ëŸ°ë°â€¦ ê³„ì—„êµ°ì´ ì‹œë¯¼ë“¤ì„ í–¥í•´ ì´ì„ ê²¨ëˆ„ì—ˆì§€. ê·¸ë‚ , ê´‘ì£¼ì—ì„œëŠ” ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë˜ ê±¸ê¹Œ?"
    }
]


# ì´ì•¼ê¸° ë‹¨ê³„ ì¶”ì¶œ í•¨ìˆ˜
def extract_contents(text):
    pattern = r"\*\*\d+ë‹¨ê³„:.*?\*\*\s*([\s\S]*?)(?=\n\s*\*\*|\Z)"
    return [match.strip() for match in re.findall(pattern, text)]

# ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸ ì •ë¦¬
def clean_text(text):
    return re.sub(r"\.\n\s*\n\s*---", "", text).strip()

# ì²« ë²ˆì§¸ í”„ë¡¬í”„íŠ¸ (ì´ì•¼ê¸° ê°œìš” ìƒì„±)
def generate_story_outline(user_input):
    global story_segments, story_progress
    story_progress = 0  # ì´ˆê¸°í™”
    
    prompt = f"""
    ğŸ¬ **ê¼¬ë¦¬ì— ê¼¬ë¦¬ë¥¼ ë¬´ëŠ” ì´ì•¼ê¸° (ê¼¬ê¼¬ë¬´) ìŠ¤íƒ€ì¼ ìŠ¤í† ë¦¬í…”ë§**
    
    ì•„ë˜ ì˜ˆì‹œ ë‹µë³€ì„ ì°¸ê³ í•´ì„œ, ì£¼ì–´ì§„ ì£¼ì œì— ëŒ€í•œ ê¼¬ê¼¬ë¬´ ìŠ¤íƒ€ì¼ì˜ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ì¤˜.
    
    ---
    **ğŸ“Œ ê¼¬ê¼¬ë¬´ ìŠ¤íƒ€ì¼ ì˜ˆì‹œ ë‹µë³€ êµ¬ì¡°**
    {few_shot_examples}
    ---
    
    **ğŸ“ ìƒì„± ê°€ì´ë“œë¼ì¸**
    - ë‹µë³€ì€ ë°˜ë“œì‹œ **ê¼¬ë¦¬ì— ê¼¬ë¦¬ë¥¼ ë¬´ëŠ” ì´ì•¼ê¸°**ì²˜ëŸ¼ êµ¬ì„±í•´ì•¼ í•´.
    - ëª¨ë“  ë¬¸ì¥ì€ **ë°˜ë§ì²´**ë¡œ ì§„í–‰í•´ì•¼ í•´.
    - ì´ **5ë‹¨ê³„**ë¡œ ë‚˜ëˆ„ì–´ ì´ì•¼ê¸°ë¥¼ ì „ê°œí•˜ë©°, ê° ë‹¨ê³„ëŠ” "1ë‹¨ê³„: "ì™€ ê°™ì´ ëª…í™•íˆ êµ¬ë¶„í•´.
    - **ê¸´ì¥ê°ê³¼ ëª°ì…ë„ë¥¼ ìœ ì§€í•˜ë„ë¡** ê° ë‹¨ê³„ë§ˆë‹¤ ë°˜ì „ ìš”ì†Œë‚˜ ê¶ê¸ˆì¦ì„ ìœ ë°œí•˜ëŠ” ë‚´ìš©ì„ í¬í•¨í•´.
    - **ìµœëŒ€í•œ ìì—°ìŠ¤ëŸ½ê³  ìƒë™ê° ìˆëŠ” ì„œìˆ  ë°©ì‹**ìœ¼ë¡œ, ë…ìê°€ ë§ˆì¹˜ ë‹¤íë©˜í„°ë¦¬ë¥¼ ë³´ë“¯ì´ í¥ë¯¸ë¡­ê²Œ ì½ì„ ìˆ˜ ìˆë„ë¡ ì‘ì„±í•´.
    - ë¬¸ì¥ ê¸¸ì´ëŠ” ì ì ˆíˆ ì¡°ì ˆí•˜ë©°, ì „ì²´ ë‹µë³€ì€ **3000ì ë‚´ì™¸**ë¡œ êµ¬ì„±í•´.
    - ê³¼ì¥ëœ í‘œí˜„ê³¼ ë¬˜ì‚¬ë¥¼ í™œìš©í•´ ë¶„ìœ„ê¸°ë¥¼ ê·¹ëŒ€í™”í•´.
    
    ---
    **ğŸ” ì§ˆë¬¸:** {user_input}
    
    ğŸ¬ **ë‹µë³€**
    """
    
    inputs = explainer_tokenizer(prompt, return_tensors="pt").to(device)
    outputs = explainer_model.generate(**inputs, max_new_tokens=4000, do_sample=True, top_p=0.9, temperature=0.8)
    full_story = explainer_tokenizer.decode(outputs[0], skip_special_tokens=True).strip()
    
    story_segments = extract_contents(full_story)
    if story_segments:
        story_progress = 1  # ì²« ë²ˆì§¸ ë‹¨ê³„ë¡œ ì§„í–‰
        return clean_text(story_segments[0])
    else:
        return "ì´ì•¼ê¸° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."

# ë‘ ë²ˆì§¸ í”„ë¡¬í”„íŠ¸ (ë‹¨ê³„ë³„ ì§„í–‰ + ì‚¬ìš©ì ë°˜ì‘ í¬í•¨)
def generate_story_segment(user_response):
    global story_progress, story_segments
    
    if story_progress >= len(story_segments):
        return "âœ… ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°ëŠ” ì—¬ê¸°ê¹Œì§€ì•¼!"
    
    prompt = f"""
    ğŸ¬ **ì§€ê¸ˆê¹Œì§€ì˜ ì´ì•¼ê¸° ìš”ì•½**  
    "{' '.join(story_segments[:story_progress])}"
    
    ğŸ—£ **ì‚¬ìš©ìì˜ ë°˜ì‘**  
    "{user_response}"
    
    ---
    ë„ˆëŠ” í•´ì„¤ìë¡œì„œ, ì‚¬ìš©ìì˜ ë°˜ì‘ì— ë§ëŠ” ì§§ê³  ì„íŒ©íŠ¸ ìˆëŠ” ë¦¬ì•¡ì…˜ì„ í•´.  
    ë‹µë³€ì€ **10ì ì´ë‚´**, **ë°˜ë§**, **ë¬¸ì¥ ëì€ ê°íƒ„ì‚¬ ë˜ëŠ” ì—¬ìš´ì„ ë‚¨ê¸°ëŠ” í‘œí˜„**ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.  
    ì´ì•¼ê¸°ì˜ ì§„í–‰ì„ ë°”ê¾¸ì§€ ì•Šì§€ë§Œ, **ê¸´ì¥ê°ì„ ìœ ì§€í•˜ê±°ë‚˜ ë‹¤ìŒ ì „ê°œë¥¼ ì•”ì‹œí•  ìˆ˜ ìˆë‹¤.**  
    ì‚¬ìš©ìì˜ ê°ì •ì— ë”°ë¼ ë§ì¶° ë°˜ì‘í•˜ë˜, í•„ìš”í•˜ë©´ ê°íƒ„ì‚¬, ì˜ë¬¸í˜•, ë‹¨í˜¸í•œ ì½”ë©˜íŠ¸ë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤.  

    ğŸ¬ **ë‹µë³€ ì˜ˆì‹œ**  
    1. ì‚¬ìš©ì: "í—‰, ë„ˆë¬´ ì†Œë¦„ ë‹ì•„", í•´ì„¤ì: "ì†Œë¦„ ë¼ì¹˜ì§€?"
    2. ì‚¬ìš©ì: "ì™€ ì§„ì§œ ëŒ€ë°•ì´ë‹¤", í•´ì„¤ì: "ëŒ€ë°•ì´ì§€!"  
    3. ì‚¬ìš©ì: "ë­ì•¼, ê°‘ìê¸° ì™œ ê·¸ë˜?", í•´ì„¤ì: "ê·¸ëŸ¬ê²Œ, ì´ìƒí•˜ì§€?"  
    4. ì‚¬ìš©ì: "ì´ì œ ì–´ë–»ê²Œ ë¼?", í•´ì„¤ì: "ë‹¤ìŒì´ ì¤‘ìš”í•´!"  
    5. ì‚¬ìš©ì: "ì„¤ë§ˆ ì£½ëŠ” ê±°ì•¼?", í•´ì„¤ì: "ê·¸ëŸ´ì§€ë„...!"  
    6. ì‚¬ìš©ì: "ì•„, ê·¸ëƒ¥ ë»”í•œ ì´ì•¼ê¸°ë„¤", í•´ì„¤ì: "ê³¼ì—° ê·¸ëŸ´ê¹Œ?"  

    ğŸ¬ **ë‹µë³€**  
    """
    
    inputs = explainer_tokenizer(prompt, return_tensors="pt").to(device)
    outputs = explainer_model.generate(**inputs, max_new_tokens=1024, do_sample=True, top_p=0.9, temperature=0.8)
    reaction = explainer_tokenizer.decode(outputs[0], skip_special_tokens=True).strip()
    
    response = reaction + "\n\n" + clean_text(story_segments[story_progress])
    story_progress += 1
    
    return response

# Gradio UI ìƒì„±
def chatbot(user_input, user_response):
    global story_progress
    
    if story_progress == 0:
        return generate_story_outline(user_input)
    else:
        return generate_story_segment(user_response)

# Gradio UI ì ìš©
with gr.Blocks(css='#chatbot .overflow-y-auto{height:750px}') as demo:
    state_chatbot = gr.State([])  # ëŒ€í™” ê¸°ë¡ ì €ì¥

    with gr.Row():
        gr.HTML("""
        <div style="text-align: center; max-width: 600px; margin: 0 auto;">
            <h1>ğŸ“œ ê¼¬ê¼¬ë¬´ RAG ì±—ë´‡</h1>
            <p style="margin-bottom: 10px; font-size: 94%">
                ì—­ì‚¬ì™€ ì‚¬ê±´ì„ íƒêµ¬í•˜ëŠ” AI ì±—ë´‡!  
            </p>
        </div>
        """)

    # ì±—ë´‡ UI
    with gr.Row():
        chatbot_ui = gr.Chatbot(elem_id='chatbot')

    # ì…ë ¥ì°½ + ë²„íŠ¼
    with gr.Row():
        txt_input = gr.Textbox(show_label=False, placeholder='ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...').style(container=False)
        btn_next = gr.Button("â¡ï¸ ë‹¤ìŒ ë‹¨ê³„")

    # ì±—ë´‡ ë™ì‘ ë¡œì§
    def chatbot_logic(state_chatbot, user_input):
        global story_progress
        
        if story_progress == 0:
            response = generate_story_outline(user_input)
        else:
            response = generate_story_segment(user_input)
        
        state_chatbot.append(("ğŸ—£ ì‚¬ìš©ì", user_input))
        state_chatbot.append(("ğŸ“œ í•´ì„¤ì", response))

        return state_chatbot, state_chatbot

    # ì…ë ¥ì°½ì—ì„œ Enter í‚¤ ì…ë ¥ ì‹œ ì‹¤í–‰
    txt_input.submit(chatbot_logic, [state_chatbot, txt_input], [state_chatbot, chatbot_ui])
    txt_input.submit(lambda: '', None, txt_input)  # ì…ë ¥ì°½ ì´ˆê¸°í™”

    # ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
    btn_next.click(chatbot_logic, [state_chatbot, txt_input], [state_chatbot, chatbot_ui])

# ì‹¤í–‰
demo.launch(debug=True, share=True)
